<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login / Registration (Passwordless)</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {
    font-family: Arial,sans-serif;
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
}
.container {
    background:white;
    border-radius:10px;
    box-shadow:0 10px 25px rgba(0,0,0,0.2);
    width:100%;
    max-width:400px;
    padding:40px;
}
.form-group {margin-bottom:20px;}
h1 {text-align:center;margin-bottom:30px;color:#333;font-size:28px;}
label {display:block;margin-bottom:8px;color:#555;font-weight:bold;}
input[type="email"] {width:100%;padding:12px;border:2px solid #ddd;border-radius:5px;font-size:14px;transition:border-color 0.3s;}
input[type="email"]:focus {outline:none;border-color:#667eea;}
.tabs {display:flex;gap:10px;margin-bottom:30px;}
.tab-btn {
    flex:1;padding:12px;border:none;background:#f0f0f0;color:#333;font-weight:bold;cursor:pointer;border-radius:5px;transition:all 0.3s;
}
.tab-btn.active {background:#667eea;color:white;}
.form-section {display:none;}
.form-section.active {display:block;}
button[type="submit"] {
    width:100%;padding:12px;background:#667eea;color:white;border:none;border-radius:5px;font-size:16px;font-weight:bold;cursor:pointer;transition:background 0.3s;
}
button[type="submit"]:hover {background:#764ba2;}
</style>
</head>
<body>
<div class="container">
    <h1>Welcome</h1>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('login')">Login / Register</button>
    </div>
    
    <!-- Email link form -->
    <form id="emailLinkForm" class="form-section active" onsubmit="sendSignInLink(event)">
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
        </div>
        <button type="submit">Send Magic Link</button>
    </form>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
import { getAuth, isSignInWithEmailLink, sendSignInLinkToEmail, signInWithEmailLink } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyDjBxNmeQ6IRi8GNwiDE8nQZnlBP_9PiEs",
    authDomain: "intellecta-bae6d.firebaseapp.com",
    projectId: "intellecta-bae6d",
    storageBucket: "intellecta-bae6d.firebasestorage.app",
    messagingSenderId: "934037113488",
    appId: "1:934037113488:web:cec0e29bb0ab29b6302615",
    measurementId: "G-CDWB3D7Q8L"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Action code settings for email link
const actionCodeSettings = {
    url: window.location.href, // redirect to same page after click
    handleCodeInApp: true
};

// Handle sending sign-in link
async function sendSignInLink(event) {
    event.preventDefault();
    const email = document.getElementById('email').value;

    try {
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        window.localStorage.setItem('emailForSignIn', email);
        alert('Magic link sent! Check your email.');
    } catch (error) {
        alert('Error sending link: ' + error.message);
    }
}

// Complete sign-in if coming from link
window.addEventListener('load', async () => {
    if (isSignInWithEmailLink(auth, window.location.href)) {
        let email = window.localStorage.getItem('emailForSignIn');
        if (!email) {
            email = window.prompt('Please provide your email for confirmation');
        }
        try {
            const result = await signInWithEmailLink(auth, email, window.location.href);
            window.localStorage.removeItem('emailForSignIn');

            // Create user doc if new
            const userDocRef = doc(db, 'users', result.user.uid);
            const docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                await setDoc(userDocRef, {
                    email: result.user.email,
                    createdAt: new Date()
                });
            }

            window.location.href = 'index.html';
        } catch (error) {
            alert('Error signing in: ' + error.message);
        }
    }
});

function switchTab(tab) {
    document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'Form')?.classList.add('active');
    event.target.classList.add('active');
}

window.switchTab = switchTab;
window.sendSignInLink = sendSignInLink;
</script>
</body>
</html>
